{% extends "base.html" %}
{% set active_page = "home" %}
{% set page_title = "Home" %}
{% block body_w_flash %}

<div class="l-box">
  {% if current_user.is_authenticated %}
  <a href="/post" class="pure-button pure-button-primary">Submit a new post!</a>
  {% else %}
  <a href="/register" class="pure-button pure-button-primary">Register and contribute!</a>
  {% endif %}
</div>
<br>

<script type="x-template" id="my-template">
<div>
  <h1>Test</h1>
  <ul>
    <li v-for="link in linkList">
      ${ link }
    </li>
  </ul>
</div>
</script>
<div id="app">
</div>

{% for post in posts %}
<div class="post">
  <div style="padding: 0px 5px 5px 0px;">
    <a class="pure-button" href="{{ post.url }}" target="_blank">
      <i class="fa fa-link"></i>&nbsp;
      <small>{{ post.url }}</small>
    </a>
  </div>
  <div>
    {% for tag in post.tags %}
    <span class="tag">
      <span style="text-align: center; padding: 5px 10px;">
        <svg width="30" height="30" data-jdenticon-hash="{{ tag.id | md5 }}">
          Fallback text for browsers not supporting canvas
        </svg>
        <span style="display:inline-block;">
          &nbsp;{{ tag.id }}
        </span>
      </span>
      <span class="buttons">
        <button class="pure-button"><i class="fa fa-thumbs-o-up"></i></button><!--
        --><span class="score">{{ tag._score | int | comma}}</span><!--
        --><button class="pure-button"><i class="fa fa-thumbs-o-down"></i></button><!--
        --><button class="pure-button {% if tag.id in subs %}pure-button-active {% endif%}"><i class="fa fa-feed"></i></button>
      </span>
    </span>
    {% endfor %}
    <button class="pure-button"><i class="fa fa-plus"></i></button>
  </div>
</div>
{% endfor %}
<script src="https://unpkg.com/vue/dist/vue.js"></script>
<script>
var app = new Vue({
  el: '#app',
  template: '#my-template',
  data: {
    tagScores: {{ tag_scores | tojson }},
    links: {},
    linkList: []
  },
  methods: {
    onload: function() {
      for (key in this.tagScores) {
        for (i = 0; i < this.tagScores[key].length; i++) { 
          var linkScore = this.tagScores[key][i];
          if (!this.links.hasOwnProperty(linkScore[0]))
            this.links[linkScore[0]] = {known_tags: {}, score: 0, id: linkScore[0]};
          this.links[linkScore[0]].score += linkScore[1];
          this.links[linkScore[0]].known_tags[key] = linkScore[1];
        }
      }
      this.linkList = Object.values(this.links);
      this.linkList.sort(function(a, b) {
        return a.score - b.score;
      });
      var fetchList = this.linkList.map(function (x) { return x.id });
      var links = this.links;
      $.ajax({
        url: '/api/v1/posts/' + fetchList.join(),
        method: 'GET',
        success: function (data) {
          for (i = 0; i < data.posts.length; i++) { 
            var dat = data.posts[i];
            for (key in dat) {
              Vue.set(links[dat.id], key, dat[key]);
            }
          }
        },
        error: function (error) {
          console.log(JSON.stringify(error));
        }
      });
    }
  },
  delimiters: ["${","}"]
});
app.onload();
</script>
{% endblock %}
