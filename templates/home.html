{% extends "base.html" %}
{% set active_page = "home" %}
{% set page_title = "Home" %}
{% block body_w_flash %}

<div class="l-box">
  {% if current_user.is_authenticated %}
  <a href="/post" class="pure-button pure-button-primary">Submit a new post!</a>
  {% else %}
  <a href="/register" class="pure-button pure-button-primary">Register and contribute!</a>
  {% endif %}
</div>

<script type="x-template" id="my-template">
<div>
  <div class="post" v-for="post in linkList">
    <div style="padding: 0px 5px 5px 0px;">
      <a class="pure-button" v-bind:href="post.url" target="_blank">
        <i class="fa fa-link"></i>&nbsp;
        <small>${ post.url }</small>
      </a>
    </div>
    <div>
      <span class="tag" v-for="(score, tag) in post.known_tags">
        <span style="text-align: center; padding: 5px 10px;">
          <span style="display:inline-block;">
            &nbsp;${ tag }
          </span>
        </span>
        <span class="buttons">
          <button class="pure-button" @click="vote(post.id, tag, 'up')"><i class="fa fa-thumbs-o-up"></i></button><!--
          --><span class="score">${ score }</span><!--
          --><button class="pure-button" @click="vote(post.id, tag, 'down')"><i class="fa fa-thumbs-o-down"></i></button>
          <button :class="{ 'pure-button-active': subscriptions.hasOwnProperty(tag) }" class="pure-button"><i class="fa fa-feed"></i></button>
        </span>
      </span>
      <span class="tag" v-for="tag in post.tags">
        <span style="text-align: center; padding: 5px 10px;">
          <span style="display:inline-block;">
            &nbsp;${ tag }
          </span>
        </span>
        <span class="buttons">
          <button class="pure-button" @click="vote(post.id, tag, 'up')"><i class="fa fa-thumbs-o-up"></i></button><!--
          --><span class="score">${ score }</span><!--
          --><button class="pure-button" @click="vote(post.id, tag, 'down')"><i class="fa fa-thumbs-o-down"></i></button>
          <button class="pure-button"><i class="fa fa-feed"></i></button>
        </span>
      </span>
      &nbsp;
      <button class="pure-button">Add new tag &nbsp;<i class="fa fa-plus"></i></button>
    </div>
  </div>
</div>
</script>
<div id="app">
</div>
<script src="/static/md5.min.js"></script>
<script src="https://unpkg.com/vue@2.1.10/dist/vue.js"></script>
<script>
var app = new Vue({
  el: '#app',
  template: '#my-template',
  data: {
    tagScores: {{ tag_scores | tojson }},
    links: {},
    linkList: [],
    subscriptions: {{ subscriptions | tojson }}
  },
  methods: {
    vote: function (post_id, tag, direction) {
      var links = this.links;
      $.ajax({
        url: '/api/v1/vote/' + post_id + '/' + tag + '/' + direction,
        method: 'GET',
        success: function (data) {
          var link = links[post_id];
          link.known_tags[tag] = data.new_score;
          link.tags = link.tags.filter(function(item) { 
            return !link.known_tags.hasOwnProperty(item);
          });
        },
        error: function (error) {
          console.log(JSON.stringify(error));
        }
      });

    },
    onload: function() {
      for (key in this.tagScores) {
        for (i = 0; i < this.tagScores[key].length; i++) { 
          var linkScore = this.tagScores[key][i];
          if (!this.links.hasOwnProperty(linkScore[0]))
            this.links[linkScore[0]] = {known_tags: {}, score: 0, id: linkScore[0]};
          this.links[linkScore[0]].score += linkScore[1];
          this.links[linkScore[0]].known_tags[key] = linkScore[1];
        }
      }
      this.linkList = Object.values(this.links);
      this.linkList.sort(function(a, b) {
        return a.score - b.score;
      });
      var fetchList = this.linkList.map(function (x) { return x.id });
      var links = this.links;
      $.ajax({
        url: '/api/v1/posts/' + fetchList.join(),
        method: 'GET',
        success: function (data) {
          for (i = 0; i < data.posts.length; i++) { 
            var dat = data.posts[i];
            dat.tags = dat.tags.filter(function(item) { 
              return !links[dat.id].known_tags.hasOwnProperty(item);
            });
            for (key in dat) {
              Vue.set(links[dat.id], key, dat[key]);
            }
            Vue.set(links[dat.id], 'id_md5', md5(dat.id));
          }
        },
        error: function (error) {
          console.log(JSON.stringify(error));
        }
      });
    }
  },
  delimiters: ["${","}"]
});
app.onload();
</script>
{% endblock %}
